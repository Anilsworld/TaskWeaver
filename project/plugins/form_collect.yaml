name: form_collect
enabled: true
required: true
plugin_only: true
description: >-
  Collect user input via a dynamic form.
  
  USE THIS FOR: User data collection, registration forms, approval forms, payment info,
  feedback forms, surveys, and any workflow step that requires user input.
  
  This is the PRIMARY plugin for collecting structured user input in workflows.
  Forms are defined declaratively - the plugin handles rendering, validation, and data collection.
  
  FORM RELATIONSHIPS: Use data from previous forms by referencing their outputs.
  Example: payment_form can use attendee_id from registration_form.
  
  **CRITICAL** - APPROVAL/HITL FORMS: When creating approval, review, confirmation, or decision forms,
  you MUST do BOTH of the following:
  
  1. Include readonly display fields with prefill showing ALL relevant data for review:
     - Use "readonly": True for display-only fields
     - Use "prefill": upstream_data to populate them with actual data
     - Include ALL context the approver needs (e.g., passenger details, flight info, amounts, etc.)
     - Place readonly display fields BEFORE the decision field
  
  2. Include hitl_config with decision_field and routing:
     - "blocking": True to pause workflow
     - "decision_field": name of the field containing the approval decision
     - "routing": dict mapping decision values to actions ("Approve": "continue", "Reject": "end")
  
  This pattern is REQUIRED for:
  - Manager/supervisor approvals
  - Review and confirm steps  
  - Any workflow pause requiring human decision
  - Approval gates before proceeding
  
  WRONG (approval without context):
  fields: [{"name": "decision", ...}, {"name": "comments", ...}]
  
  CORRECT (approval with full context):
  fields: [
    {"name": "display_field1", "prefill": data1, "readonly": True},
    {"name": "display_field2", "prefill": data2, "readonly": True},
    {"name": "decision", "type": "select", ...},
    {"name": "comments", "type": "textarea"}
  ]

examples: |-
  # ========== REGISTRATION FORM ==========
  # Collect attendee information
  registration_data, desc = form_collect(
      "registration",
      {
          "title": "Event Registration",
          "fields": [
              {"name": "attendee_name", "label": "Full Name", "required": True},
              {"name": "email", "label": "Email Address", "required": True},
              {"name": "phone", "label": "Phone Number"},
              {"name": "ticket_type", "label": "Ticket Type", "type": "select", 
               "options": ["VIP", "Standard", "Free"]}
          ]
      }
  )
  # registration_data = {"attendee_name": "John Doe", "email": "john@example.com", ...}
  
  # ========== PAYMENT FORM (using data from registration) ==========
  # Collect payment after registration
  payment_data, desc = form_collect(
      "payment",
      {
          "title": "Payment Information",
          "fields": [
              {"name": "card_number", "label": "Card Number", "required": True},
              {"name": "expiry", "label": "Expiry Date", "type": "date", "required": True},
              {"name": "cvv", "label": "CVV", "type": "number", "required": True}
          ],
          "prefill": {
              "email": registration_data["email"]  # Use data from previous form
          }
      }
  )
  
  # ========== APPROVAL FORM (REQUIRES hitl_config + readonly display fields!) ==========
  # Get manager approval - MUST include:
  # 1. Readonly display fields with prefill (showing data to approve)
  # 2. hitl_config for workflow control
  approval, desc = form_collect(
      "approval",
      {
          "title": "Manager Approval Required",
          "description": "Please review the registration details below and approve or reject.",
          "fields": [
              # Display fields FIRST (readonly with prefill from previous steps)
              {"name": "attendee_name", "label": "Attendee Name", 
               "prefill": registration_data['attendee_name'], "readonly": True},
              {"name": "email", "label": "Email", 
               "prefill": registration_data['email'], "readonly": True},
              {"name": "ticket_type", "label": "Ticket Type", 
               "prefill": registration_data['ticket_type'], "readonly": True},
              {"name": "payment_amount", "label": "Payment Amount",
               "prefill": f"${payment_data['amount']}", "readonly": True},
              # Decision fields AFTER display context
              {"name": "decision", "label": "Approve this request?", "type": "select",
               "options": ["Approve", "Reject", "Request Changes"], "required": True},
              {"name": "comments", "label": "Comments", "type": "textarea"}
          ],
          "hitl_config": {  # REQUIRED for approval forms!
              "blocking": True,
              "decision_field": "decision",
              "routing": {
                  "Approve": "continue",
                  "Reject": "end",
                  "Request Changes": "loop_back"
              }
          }
      }
  )
  
  # ========== FEEDBACK FORM ==========
  # Collect post-event feedback
  feedback, desc = form_collect(
      "feedback",
      {
          "title": "Event Feedback",
          "fields": [
              {"name": "rating", "label": "Overall Rating", "type": "select",
               "options": ["1", "2", "3", "4", "5"], "required": True},
              {"name": "comments", "label": "Additional Comments", "type": "textarea"},
              {"name": "would_recommend", "label": "Would you recommend?", "type": "boolean"}
          ]
      }
  )
  
  # ========== HITL APPROVAL (Human-in-the-Loop) ==========
  # COMPLETE PATTERN: Display ALL relevant data from previous steps as readonly fields
  # This allows the approver to make an INFORMED decision
  approval, desc = form_collect(
      "manager_approval",
      {
          "title": "Manager Approval Required",
          "description": "Please review all details below before approving or rejecting.",
          "fields": [
              # Display ALL context from upstream steps (readonly + prefill)
              {"name": "passenger_name", "label": "Passenger Name",
               "prefill": registration_data['attendee_name'], "readonly": True},
              {"name": "passenger_email", "label": "Email",
               "prefill": registration_data['email'], "readonly": True},
              {"name": "departure_city", "label": "From",
               "prefill": flight_result['departure_city'], "readonly": True},
              {"name": "arrival_city", "label": "To",
               "prefill": flight_result['arrival_city'], "readonly": True},
              {"name": "departure_date", "label": "Departure",
               "prefill": flight_result['departure_date'], "readonly": True},
              {"name": "total_cost", "label": "Total Cost",
               "prefill": f"${flight_result['cost']}", "readonly": True},
              # Decision fields at the end
              {"name": "decision", "label": "Your Decision", "type": "select",
               "options": ["Approve", "Reject", "Request Changes"], "required": True},
              {"name": "comments", "label": "Comments/Feedback", "type": "textarea"}
          ],
          "hitl_config": {
              "blocking": True,
              "timeout_hours": 24,
              "decision_field": "decision",
              "routing": {
                  "Approve": "continue",
                  "Reject": "end",
                  "Request Changes": "loop_back"
              }
          }
      }
  )

parameters:
  - name: form_id
    type: str
    required: true
    description: >-
      Unique identifier for this form (e.g., "registration", "payment", "feedback").
      Used to track form submissions and link data across workflow steps.
      
  - name: schema
    type: dict
    required: true
    description: >-
      Form schema definition with the following structure:
      {
        "title": "Form Title",
        "description": "Optional description",
        "fields": [
          {
            "name": "field_name",           # Required: field identifier
            "label": "Human Label",         # Optional: display label (auto-generated if not provided)
            "type": "text",                 # Optional: field type (auto-inferred if not provided)
            "required": true/false,         # Optional: is field required (default: false)
            "options": ["opt1", "opt2"],    # Required for select/multiselect types
            "placeholder": "Enter value",   # Optional: placeholder text
            "default": "default_value"      # Optional: default value
          }
        ],
        "prefill": {                        # Optional: pre-fill with data from previous steps
          "field_name": value_from_previous_step
        }
      }
      
      FIELD TYPES (auto-inferred from name if not specified):
      - text: Short text input (names, titles)
      - email: Email address with validation
      - tel: Phone number
      - number: Numeric values
      - date: Date picker
      - datetime: Date and time
      - textarea: Multi-line text
      - select: Single choice dropdown (requires "options")
      - multiselect: Multiple choice (requires "options")
      - boolean: Yes/No toggle
      - file, image, pdf, video, audio: File uploads

returns:
  - name: data
    type: dict
    description: >-
      Collected form data as a dictionary mapping field names to values.
      Example: {"attendee_name": "John", "email": "john@example.com", "ticket_type": "VIP"}
      
  - name: description
    type: str
    description: Form submission status and summary.

configurations:
  timeout_seconds: 3600

