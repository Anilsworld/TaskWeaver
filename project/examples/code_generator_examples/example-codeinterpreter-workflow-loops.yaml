enabled: True
description: >-
  LOOP pattern for repetitive operations (90% token reduction).
  
  üîÅ USE LOOPS when user says "fetch from A, B, C" or "send to X, Y, Z"
  - Same operation repeated across multiple items
  - All items use THE SAME tool_id
  - Example: "Read messages from Gmail, Outlook, Slack, Teams"
    ‚úÖ USE: loops (1500 tokens) vs ‚ùå 4 separate nodes (6000 tokens)
  
  ‚ö° LOOP BENEFITS:
  - 70-90% token reduction (scales infinitely)
  - No LLM token limits (loop definition is tiny)
  - Runtime expands to N parallel executions via LangGraph Send pattern
  
  üö® ONLY use loops when SAME tool_id for all items!
  - Different operations? Use parallel_groups instead
  
  üìù ALTERNATIVE SIMPLE EXAMPLES:
  1. "Get my last 3 Slack messages and reply to each" ‚Üí Loop over messages, reply to each
  2. "Search for flights to Paris, London, Tokyo and save to spreadsheet" ‚Üí Loop searches, aggregate results
  3. "Invite users alice@email.com, bob@email.com, carol@email.com to meeting" ‚Üí Loop over emails, send invites

rounds:
  - user_query: Create a workflow to search for flights to Paris, London, and Tokyo, then create a spreadsheet with all the results.
    state: finished
    post_list:
      - message: Search for flights to Paris, London, and Tokyo, then create a spreadsheet with all the results.
        send_from: Planner
        send_to: CodeInterpreter
        attachment_list: []
      
      - message: I've created an optimized workflow using LOOP pattern to handle 3 destinations with minimal tokens.
        send_from: CodeInterpreter
        send_to: Planner
        attachment_list:
          - type: thought
            content: |-
              üîç COMPLEXITY ANALYSIS DETECTED:
              - Operation: "search flights" (same action repeated)
              - Destinations: Paris, London, Tokyo (3 items)
              - Tool: FLIGHT_SEARCH (same tool_id for all destinations)
              
              ‚úÖ DECISION: USE LOOP PATTERN
              - WITHOUT loop: 3 search nodes = 3 nodes √ó 800 tokens = 2400 tokens
              - WITH loop: 1 loop definition + 2 other nodes = 3 items √ó 400 tokens = 1200 tokens
              - SAVINGS: 1200 tokens (50% reduction!)
              
              üìã WORKFLOW STRUCTURE:
              1. collect_destinations: Form to get list of destinations from user
              2. search_flights_loop: Loop over destinations, search for each
              3. create_spreadsheet: Create spreadsheet with results
              4. update_spreadsheet: Add all flight results to spreadsheet
              
              üîÅ LOOP SYNTAX:
              loops: [{
                "id": "loop_id",
                "loop_over": "${{from_step:step_id.field_name}}",
                "nodes": [{"id": "nested_node", "type": "agent_with_tools", ...}],
                "parallel": True,
                "max_iterations": 10
              }]
              
              üì¶ LOOP OUTPUT AGGREGATION:
              - Loop results are automatically collected in loop_aggregated_outputs
              - Reference aggregated results: ${{from_loop:loop_id.field_name}}
              - Example: ${{from_loop:search_flights_loop.results}} gets ALL results from loop
              - This is different from ${{from_step:...}} which references individual node outputs
              - Use loop aggregation to collect data from ALL iterations for downstream processing
          
          - type: reply_type
            content: python
          
          - type: reply_content
            content: |-
              WORKFLOW = {
                "nodes": [
                  {"id": "collect_destinations", "type": "form", "form_id": "destination_form", "title": "Select Destinations", "fields": [{"name": "destinations", "label": "Cities to search flights for", "type": "multiselect", "options": ["Paris", "London", "Tokyo"], "required": True}], "description": "Collect list of destinations"},
                  {"id": "search_flights_loop", "type": "loop", "loop_over": "${{from_step:collect_destinations.destinations}}", "nodes": [
                    {"id": "search_flight", "type": "agent_with_tools", "tool_id": "FLIGHT_SEARCH", "app_name": "skyscanner", "params": {"destination": "${{loop_item}}", "departure_date": "2024-06-01", "return_date": "2024-06-08"}, "description": "Search flights to destination"}
                  ], "max_iterations": 3, "description": "Search flights for each destination"},
                  {"id": "create_spreadsheet", "type": "agent_with_tools", "tool_id": "GOOGLESHEETS_CREATE_GOOGLE_SHEET1", "app_name": "googlesheets", "params": {"title": "Flight Search Results"}, "depends_on": ["search_flights_loop"], "description": "Create spreadsheet for results"},
                  {"id": "update_spreadsheet", "type": "agent_with_tools", "tool_id": "GOOGLESHEETS_BATCH_UPDATE", "app_name": "googlesheets", "params": {"spreadsheet_id": "${{from_step:create_spreadsheet.spreadsheetId}}", "sheet_name": "Sheet1", "values": [["Destination", "Price", "Airline"], "${{from_loop:search_flights_loop.results}}"]}, "depends_on": ["create_spreadsheet"], "description": "Add all flight results to spreadsheet"}
                ],
                "sequential_edges": [("collect_destinations", "search_flights_loop"), ("search_flights_loop", "create_spreadsheet"), ("create_spreadsheet", "update_spreadsheet")]
              }
              result = WORKFLOW

