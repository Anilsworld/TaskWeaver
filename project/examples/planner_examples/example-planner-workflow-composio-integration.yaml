enabled: True
rounds:
  - user_query: Read data from my spreadsheet "Monthly Expenses" and send a summary email
    state: created
    post_list:
      - message: Read data from my spreadsheet "Monthly Expenses" and send a summary email
        send_from: User
        send_to: Planner
        attachment_list:
      - message: I'll create a workflow to read your spreadsheet data and send a summary email. Please generate Python code to search for the spreadsheet by name, read its data, analyze it, and send an email summary.
        send_from: Planner
        send_to: CodeInterpreter
        attachment_list:
          - type: plan_reasoning
            content: |-
              The user wants to read data from a Google Sheets spreadsheet and send an email summary. I need to use composio_action plugin to:
              1. Search for the spreadsheet by name to get its ID
              2. Read the spreadsheet data using the ID
              3. Analyze the data to create a summary
              4. Send an email with the summary
          - type: init_plan
            content: |-
              1. Search for spreadsheet "Monthly Expenses" to get its ID using composio_action
              2. Read spreadsheet data using the ID <sequentially depends on 1>
              3. Analyze the expense data to calculate totals and categories <sequentially depends on 2>
              4. Send email summary using composio_action <sequentially depends on 3>
              5. Report completion to user <sequentially depends on 4>
          - type: plan
            content: |-
              1. Generate code to search spreadsheet, read data, analyze, and send email
              2. Report completion to user
          - type: current_plan_step
            content: 1. Generate code to search spreadsheet, read data, analyze, and send email
          - type: stop
            content: InProcess
      - message: Successfully read spreadsheet data and sent email summary.
        send_from: CodeInterpreter
        send_to: Planner
        attachment_list:
          - type: thought
            content: I will use composio_action plugin to interact with Google Sheets and Gmail APIs. First search for the spreadsheet, then read data, analyze, and send email.
          - type: reply_type
            content: python
          - type: reply_content
            content: |-
              # Note: _entity_id is automatically available from the workflow execution context
              # It contains the user's email for Composio authentication
              
              # Step 1: Search for spreadsheet by name to get the ID
              search_result, search_desc = composio_action(
                  action_name="GOOGLESHEETS_FIND_SPREADSHEET",
                  params={"name": "Monthly Expenses"},
                  entity_id=_entity_id if '_entity_id' in dir() else None
              )
              
              if search_result.get('error'):
                  print(f"Error searching for spreadsheet: {search_result.get('error_message')}")
              else:
                  spreadsheets = search_result.get('spreadsheets', [])
                  if not spreadsheets:
                      print("Spreadsheet 'Monthly Expenses' not found")
                  else:
                      spreadsheet_id = spreadsheets[0].get('spreadsheetId')
                      print(f"Found spreadsheet with ID: {spreadsheet_id}")
                      
                      # Step 2: Read spreadsheet data
                      data_result, data_desc = composio_action(
                          action_name="GOOGLESHEETS_SPREADSHEETS_VALUES_BATCH_GET",
                          params={
                              "spreadsheetId": spreadsheet_id,
                              "ranges": ["Sheet1!A1:D100"]
                          },
                          entity_id=_entity_id if '_entity_id' in dir() else None
                      )
                      
                      if data_result.get('error'):
                          print(f"Error reading data: {data_result.get('error_message')}")
                      else:
                          # Step 3: Analyze the expense data
                          values = data_result.get('valueRanges', [{}])[0].get('values', [])
                          
                          if len(values) > 1:
                              headers = values[0]
                              data_rows = values[1:]
                              
                              # Calculate totals by category
                              summary = "Monthly Expenses Summary\n"
                              summary += "=" * 40 + "\n\n"
                              
                              total = 0
                              categories = {}
                              
                              for row in data_rows:
                                  if len(row) >= 3:
                                      category = row[0] if row[0] else "Other"
                                      try:
                                          amount = float(str(row[2]).replace('$', '').replace(',', ''))
                                          total += amount
                                          categories[category] = categories.get(category, 0) + amount
                                      except (ValueError, IndexError):
                                          pass
                              
                              summary += "By Category:\n"
                              for cat, amt in sorted(categories.items(), key=lambda x: -x[1]):
                                  summary += f"  {cat}: ${amt:.2f}\n"
                              
                              summary += f"\nTotal Expenses: ${total:.2f}\n"
                              summary += f"Number of Entries: {len(data_rows)}\n"
                              
                              print(summary)
                              
                              # Step 4: Send email with summary
                              email_result, email_desc = composio_action(
                                  action_name="GMAIL_SEND_EMAIL",
                                  params={
                                      "to": "user@example.com",
                                      "subject": "Monthly Expenses Summary",
                                      "body": summary
                                  },
                                  entity_id=_entity_id if '_entity_id' in dir() else None
                              )
                              
                              if email_result.get('error'):
                                  print(f"Error sending email: {email_result.get('error_message')}")
                              else:
                                  print("Summary email sent successfully!")
                          else:
                              print("No expense data found in spreadsheet")
          - type: verification
            content: CORRECT
          - type: code_error
            content: No code error.
          - type: execution_status
            content: SUCCESS
          - type: execution_result
            content: Successfully read expense data from spreadsheet and sent summary email.
      - message: I've read your "Monthly Expenses" spreadsheet and sent a summary email. The summary includes expense totals by category and the total amount.
        send_from: Planner
        send_to: User
        attachment_list:
          - type: plan_reasoning
            content: |-
              The workflow successfully:
              1. Found the spreadsheet by name
              2. Read the expense data
              3. Calculated totals by category
              4. Sent a summary email
          - type: init_plan
            content: |-
              1. Search for spreadsheet "Monthly Expenses" to get its ID using composio_action
              2. Read spreadsheet data using the ID <sequentially depends on 1>
              3. Analyze the expense data to calculate totals and categories <sequentially depends on 2>
              4. Send email summary using composio_action <sequentially depends on 3>
              5. Report completion to user <sequentially depends on 4>
          - type: plan
            content: |-
              1. Generate code to search spreadsheet, read data, analyze, and send email
              2. Report completion to user
          - type: current_plan_step
            content: 2. Report completion to user
          - type: stop
            content: Completed

