enabled: True
rounds:
  # ===========================================================================
  # COMPLEX WORKFLOW: Multi-step execution within ONE round
  # ===========================================================================
  # TaskWeaver pattern (session.py lines 207-216):
  #   while True:
  #       post = _send_message(post.send_to, post)  # Planner <-> CodeInterpreter
  #       if post.send_to == "User":
  #           break  # Only exits when complete
  #
  # For complex workflows with <interactively depends on>:
  # - Planner sends Step 1 to CodeInterpreter -> code_block_1
  # - Planner sends Step 2 to CodeInterpreter -> code_block_2  
  # - Planner sends Step 3 to CodeInterpreter -> code_block_3
  # - Planner sends final message to User
  #
  # ALL steps are in ONE round with multiple internal exchanges.
  # ===========================================================================
  - user_query: Create an event registration workflow with registration form, payment, manager approval, calendar event, confirmation email, and feedback collection
    state: created
    post_list:
      # =====================================================================
      # User -> Planner (start of round)
      # =====================================================================
      - message: Create an event registration workflow with registration form, payment, manager approval, calendar event, confirmation email, and feedback collection
        send_from: User
        send_to: Planner
        attachment_list:

      # =====================================================================
      # Planner -> CodeInterpreter: PHASE 1 (Forms)
      # =====================================================================
      - message: Generate code for registration and payment forms with data flow between them.
        send_from: Planner
        send_to: CodeInterpreter
        attachment_list:
          - type: plan_reasoning
            content: |-
              This is a complex 6-step workflow. Using <interactively depends on> to generate code in phases:
              Phase 1: Forms (registration, payment)
              Phase 2: Approval + APIs (calendar, email)  
              Phase 3: Feedback
          - type: init_plan
            content: |-
              1. Collect registration info using form_collect
              2. Collect payment with prefill from registration <sequentially depends on 1>
              3. Get manager approval <interactively depends on 2>
              4. Create calendar event <interactively depends on 3>
              5. Send confirmation email <interactively depends on 4>
              6. Collect feedback <interactively depends on 5>
          - type: plan
            content: |-
              1. Generate forms (Phase 1)
              2. Generate approval + APIs (Phase 2)
              3. Generate feedback (Phase 3)
          - type: current_plan_step
            content: 1. Generate forms (Phase 1)
          - type: stop
            content: InProcess

      # =====================================================================
      # CodeInterpreter -> Planner: PHASE 1 code
      # =====================================================================
      - message: Phase 1 forms generated.
        send_from: CodeInterpreter
        send_to: Planner
        attachment_list:
          - type: thought
            content: Generating registration and payment forms with data flow.
          - type: reply_type
            content: python
          - type: reply_content
            content: |-
              # PHASE 1: Registration and Payment Forms
              registration, _ = form_collect("registration", {
                  "title": "Event Registration",
                  "fields": [
                      {"name": "full_name", "label": "Full Name", "type": "text", "required": True},
                      {"name": "email", "label": "Email", "type": "email", "required": True},
                      {"name": "phone", "label": "Phone", "type": "text"},
                      {"name": "company", "label": "Company", "type": "text"}
                  ]
              })
              
              payment, _ = form_collect("payment", {
                  "title": "Payment Details",
                  "fields": [
                      {"name": "email", "label": "Email", "type": "email", "prefill": registration['email']},
                      {"name": "card_number", "label": "Card Number", "type": "text", "required": True},
                      {"name": "amount", "label": "Amount", "type": "number", "required": True}
                  ]
              })
          - type: verification
            content: CORRECT
          - type: execution_status
            content: SUCCESS
          - type: execution_result
            content: Forms ready.

      # =====================================================================
      # Planner -> CodeInterpreter: PHASE 2 (Approval + APIs)
      # =====================================================================
      - message: Phase 1 complete. Now generate approval and API calls for calendar and email.
        send_from: Planner
        send_to: CodeInterpreter
        attachment_list:
          - type: plan_reasoning
            content: Phase 1 forms done. Generating Phase 2 - approval with HITL and API integrations.
          - type: init_plan
            content: |-
              1. Collect registration info using form_collect
              2. Collect payment with prefill from registration <sequentially depends on 1>
              3. Get manager approval <interactively depends on 2>
              4. Create calendar event <interactively depends on 3>
              5. Send confirmation email <interactively depends on 4>
              6. Collect feedback <interactively depends on 5>
          - type: plan
            content: |-
              1. Generate forms (Phase 1) - DONE
              2. Generate approval + APIs (Phase 2)
              3. Generate feedback (Phase 3)
          - type: current_plan_step
            content: 2. Generate approval + APIs (Phase 2)
          - type: stop
            content: InProcess

      # =====================================================================
      # CodeInterpreter -> Planner: PHASE 2 code
      # =====================================================================
      - message: Phase 2 approval and APIs generated.
        send_from: CodeInterpreter
        send_to: Planner
        attachment_list:
          - type: thought
            content: Generating manager approval with HITL and API calls.
          - type: reply_type
            content: python
          - type: reply_content
            content: |-
              # PHASE 2: Approval and External APIs
              approval, _ = form_collect("manager_approval", {
                  "title": "Manager Approval",
                  "description": f"Registration for {registration['full_name']} - ${payment['amount']}",
                  "fields": [
                      {"name": "decision", "label": "Decision", "type": "select", "options": ["Approve", "Reject"]},
                      {"name": "comments", "label": "Comments", "type": "textarea"}
                  ],
                  "hitl_config": {"blocking": True, "decision_field": "decision"}
              })
              
              if approval['decision'] == "Approve":
                  calendar_event, _ = composio_action("GOOGLECALENDAR_CREATE_EVENT", {
                      "title": f"Event - {registration['full_name']}",
                      "attendees": [registration['email']]
                  })
                  
                  email_result, _ = composio_action("GMAIL_SEND_EMAIL", {
                      "to": registration['email'],
                      "subject": "Registration Confirmed",
                      "body": f"Dear {registration['full_name']}, your registration is confirmed."
                  })
          - type: verification
            content: CORRECT
          - type: execution_status
            content: SUCCESS
          - type: execution_result
            content: Approval and APIs ready.

      # =====================================================================
      # Planner -> CodeInterpreter: PHASE 3 (Feedback)
      # =====================================================================
      - message: Phase 2 complete. Generate the feedback collection form.
        send_from: Planner
        send_to: CodeInterpreter
        attachment_list:
          - type: plan_reasoning
            content: Phases 1 and 2 done. Generating final Phase 3 - feedback form.
          - type: init_plan
            content: |-
              1. Collect registration info using form_collect
              2. Collect payment with prefill from registration <sequentially depends on 1>
              3. Get manager approval <interactively depends on 2>
              4. Create calendar event <interactively depends on 3>
              5. Send confirmation email <interactively depends on 4>
              6. Collect feedback <interactively depends on 5>
          - type: plan
            content: |-
              1. Generate forms (Phase 1) - DONE
              2. Generate approval + APIs (Phase 2) - DONE
              3. Generate feedback (Phase 3)
          - type: current_plan_step
            content: 3. Generate feedback (Phase 3)
          - type: stop
            content: InProcess

      # =====================================================================
      # CodeInterpreter -> Planner: PHASE 3 code
      # =====================================================================
      - message: Phase 3 feedback form generated. All phases complete.
        send_from: CodeInterpreter
        send_to: Planner
        attachment_list:
          - type: thought
            content: Generating feedback collection form.
          - type: reply_type
            content: python
          - type: reply_content
            content: |-
              # PHASE 3: Feedback Collection
              feedback, _ = form_collect("feedback", {
                  "title": "Event Feedback",
                  "fields": [
                      {"name": "rating", "label": "Rating (1-5)", "type": "number", "required": True},
                      {"name": "comments", "label": "Comments", "type": "textarea"},
                      {"name": "recommend", "label": "Would Recommend?", "type": "select", "options": ["Yes", "No"]}
                  ]
              })
              
              result = {"registration": registration, "payment": payment, "approval": approval, "feedback": feedback}
          - type: verification
            content: CORRECT
          - type: execution_status
            content: SUCCESS
          - type: execution_result
            content: All 3 phases complete.

      # =====================================================================
      # Planner -> User (end of round - workflow complete)
      # =====================================================================
      - message: The event registration workflow is complete! It includes registration form, payment with prefill, manager approval, calendar event, confirmation email, and feedback collection.
        send_from: Planner
        send_to: User
        attachment_list:
          - type: plan_reasoning
            content: |-
              Generated complex workflow in 3 phases to avoid token limits:
              - Phase 1: Forms (registration, payment with prefill)
              - Phase 2: Approval (HITL) + APIs (calendar, email)
              - Phase 3: Feedback
              Each phase fits in LLM token limit. All code blocks will be combined.
          - type: init_plan
            content: |-
              1. Collect registration info using form_collect
              2. Collect payment with prefill from registration <sequentially depends on 1>
              3. Get manager approval <interactively depends on 2>
              4. Create calendar event <interactively depends on 3>
              5. Send confirmation email <interactively depends on 4>
              6. Collect feedback <interactively depends on 5>
          - type: plan
            content: |-
              1. Generate forms (Phase 1) - DONE
              2. Generate approval + APIs (Phase 2) - DONE
              3. Generate feedback (Phase 3) - DONE
          - type: current_plan_step
            content: All phases complete
          - type: stop
            content: Completed

