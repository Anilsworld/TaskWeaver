enabled: True
rounds:
  - user_query: Create a workflow to process orders with approval and notification
    state: created
    post_list:
      - message: Create a workflow to process orders with approval and notification
        send_from: User
        send_to: Planner
        attachment_list:
      - message: Collect order details, add approval step with conditional logic, and send notifications based on approval decision.
        send_from: Planner
        send_to: CodeInterpreter
        attachment_list:
          - type: plan_reasoning
            content: |-
              **PATTERN RECOGNITION:** User wants: collect data → approve → send notification based on decision.
              This demonstrates the UNIVERSAL "fetch → approve → act" pattern that applies to ANY workflow.
              
              Following the complete workflow rules:
              1. Fetch ALL data BEFORE approval (order details + inventory/pricing) so approver sees complete context
              2. User said "send notification" AFTER approval → MUST include notification step in plan
              3. Notification is CONDITIONAL on approval decision → Use if/else logic
              
              This pattern works for ANY scenario: orders→emails, messages→replies, documents→publish, requests→process, etc.
          - type: init_plan
            content: |-
              1. Collect order details using form_collect() with structured fields
              2. Check inventory and get pricing for the ordered product using composio_action <sequentially depends on 1>
              3. Add HITL approval step with decision fields only (system auto-injects all context) <sequentially depends on 2>
              4. Send email notifications using composio_action based on approval decision <sequentially depends on 3>
              5. Report result to user <interactively depends on 4>
          - type: plan
            content: |-
              1. Instruct CodeInterpreter to generate complete workflow code
              2. Report result to user
          - type: current_plan_step
            content: 1. Instruct CodeInterpreter to generate complete workflow code
          - type: stop
            content: InProcess
      - message: Workflow executed successfully with order collection, approval logic, and conditional notifications.
        send_from: CodeInterpreter
        send_to: Planner
        attachment_list:
          - type: thought
            content: |-
              **IMPLEMENTING UNIVERSAL "FETCH → APPROVE → ACT" PATTERN:**
              
              1. Collect input using form_collect()
              2. Fetch data using composio_action (before approval so approver sees context)
              3. HITL approval with decision field (system auto-injects all context)
              4. **CRITICAL: Execute post-approval action based on decision** (if approved → send email, if rejected → send rejection)
              
              This demonstrates the complete workflow pattern that works for ANY scenario - the key is including the ACTION after approval, not just collecting approval!
          - type: reply_type
            content: python
          - type: reply_content
            content: |-
              # Step 1: Collect order details using form_collect()
              order_details, desc = form_collect("order_details", {
                  "title": "Order Information",
                  "description": "Enter the order details",
                  "fields": [
                      {"name": "customer_name", "label": "Customer Name", "required": True},
                      {"name": "product", "label": "Product Name", "required": True},
                      {"name": "quantity", "label": "Quantity", "type": "number", "required": True}
                  ]
              })
              
              # Step 2: Check inventory and get pricing (DATA FETCH - comes BEFORE approval)
              inventory_check, desc = composio_action("COMPOSIO_SEARCH_TOOLS", {
                  "query": f"Check inventory for {order_details['product']}"
              })
              
              # Calculate pricing based on quantity
              unit_price = 29.99
              total_amount = unit_price * order_details['quantity']
              availability_status = "In Stock" if len(inventory_check) > 0 else "Out of Stock"
              
              # Step 3: HITL Approval (system will auto-inject ALL context + downstream actions)
              # ✅ CRITICAL PATTERN: Approval comes AFTER data is fetched
              # ✅ NEW PATTERN: Only provide decision fields - system adds context automatically
              approval, desc = form_collect("order_approval", {
                  "title": "Order Approval Required",
                  "description": "Review the order details and decide",
                  "fields": [
                      # ONLY decision fields - system will automatically inject:
                      # - order_details (customer_name, product, quantity)
                      # - inventory_check results
                      # - calculated pricing (unit_price, total_amount, availability)
                      # - downstream email preview (recipient, subject, body)
                      {"name": "decision", "label": "Decision", "type": "select", "options": ["Approve", "Reject"], "required": True},
                      {"name": "comments", "label": "Comments", "type": "textarea"}
                  ],
                  "hitl_config": {"blocking": True, "decision_field": "decision"}
              })
              
              # Step 4: Send notification based on approval decision
              if approval['decision'] == "Approve":
                  email_result, desc = composio_action("GMAIL_SEND_EMAIL", {
                      "to": f"{order_details['customer_name']}@example.com",
                      "subject": "Order Approved",
                      "body": f"Your order for {order_details['quantity']} x {order_details['product']} (${total_amount}) has been approved!"
                  })
                  result = "Order approved and confirmation sent"
              else:
                  email_result, desc = composio_action("GMAIL_SEND_EMAIL", {
                      "to": f"{order_details['customer_name']}@example.com",
                      "subject": "Order Rejected",
                      "body": f"Your order has been rejected. Reason: {approval.get('comments', 'No reason provided')}"
                  })
                  result = "Order rejected and notification sent"
              
              result
          - type: verification
            content: CORRECT
          - type: code_error
            content: No code error.
          - type: execution_status
            content: SUCCESS
          - type: execution_result
            content: Order workflow completed with approval logic and notifications.
      - message: The workflow is complete! It collects order details, requires approval, and sends different notifications based on whether the order is approved or denied.
        send_from: Planner
        send_to: User
        attachment_list:
          - type: plan_reasoning
            content: |-
              **PATTERN SUCCESSFULLY APPLIED (works for ANY workflow):**
              
              ✅ Step 1: Collect input (form_collect for order details)
              ✅ Step 2: Fetch context BEFORE approval (composio_action for inventory/pricing)
              ✅ Step 3: HITL approval showing ALL data (system auto-injects order + inventory + pricing + downstream preview)
              ✅ Step 4: **POST-APPROVAL ACTION** (composio_action to send email - CONDITIONAL on decision)
              
              **This GENERIC pattern applies to:**
              - Orders → Emails (this example)
              - Messages → Replies (substitute message fetch + reply actions)
              - Documents → Publish (substitute document fetch + publish actions)
              - Requests → Process (substitute request fetch + process actions)
              - ANY "fetch → review → act" workflow (fully dynamic, no hardcoding)
          - type: init_plan
            content: |-
              1. Collect order details using form_collect() with structured fields
              2. Check inventory and get pricing for the ordered product using composio_action <sequentially depends on 1>
              3. Add HITL approval step with decision fields only (system auto-injects all context) <sequentially depends on 2>
              4. Send email notifications using composio_action based on approval decision <sequentially depends on 3>
              5. Report result to user <interactively depends on 4>
          - type: plan
            content: |-
              1. Instruct CodeInterpreter to generate complete workflow code
              2. Report result to user
          - type: current_plan_step
            content: 2. Report result to user
          - type: stop
            content: Completed

